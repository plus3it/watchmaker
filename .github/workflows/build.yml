name: Build and test

on:
  # Run on demand
  workflow_dispatch:

  # Run pull requests against the default branch
  pull_request:
    branches: [main]

  # Run on push to default branch
  push:
    branches: [main]

concurrency:
  group: build-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  checkout:
    runs-on: ubuntu-latest
    outputs:
      release-condition: ${{ steps.release.outputs.condition }}
      release-version: ${{ steps.release.outputs.version }}
      uv-version: ${{ steps.uv.outputs.version }}
    steps:
      - name: Checkout code
        id: checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
        with:
          fetch-depth: 0
          fetch-tags: true
          submodules: recursive

      - name: Set version and check release condition
        id: release
        shell: bash
        run: |
          set -eu -o pipefail
          RELEASE=false
          PRIOR_VERSION=$(git describe --abbrev=0 --tags || true)
          RELEASE_VERSION=$(grep -E "current_version\s*=" .bumpversion.cfg | sed 's/^.*= //' )
          if [[ "$PRIOR_VERSION" = "$RELEASE_VERSION" ]]; then
            # If the current version matches the last tag, we are in a dev build.
            # Update the version in pyproject.toml to include a timestamp.
            ver=$(git show -s --format=%cd --date=format:'%Y%m%d%H%M%S')
            sed -i -E "s/^(version = \")([0-9]+\.[0-9]+\.[0-9]+)(\".*)?$/\1\2.dev$ver\3/" pyproject.toml
          else
            # If the current version does not match the last tag, we are in a release build.
            RELEASE=true
          fi
          VERSION="$(grep -E '^version\s*=' pyproject.toml | sed 's/^version = "\(.*\)"$/\1/')"
          echo "condition=${RELEASE}"
          echo "version=${VERSION}"
          echo "condition=${RELEASE}" >> "$GITHUB_OUTPUT"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Get uv version
        id: uv
        run: |
          UV_VERSION=$(grep '^uv==' requirements/basics.txt | cut -d'=' -f3)
          echo "uv-version=${UV_VERSION}"
          echo "version=${UV_VERSION}" >> "$GITHUB_OUTPUT"

      - name: Upload source
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4
        with:
          name: source
          path: ./**
          if-no-files-found: error
          include-hidden-files: true
          retention-days: 1

  build:
    name: ${{ matrix.name }}
    needs: checkout
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - python-version: "3.12"
            name: build
    steps:
      - name: Retrieve source
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53
        with:
          name: source
          path: .

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install uv
        uses: astral-sh/setup-uv@5a7eac68fb9809dea845d802897dc5c723910fa3
        with:
          version: ${{ needs.checkout.outputs.uv-version }}
          activate-environment: "true"
          enable-cache: "false"

      - name: Build package
        run: uv build --verbose

      - name: Upload distributions
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4
        with:
          name: dists
          path: dist/
          if-no-files-found: error
          retention-days: 1

  standalone:
    name: standalone (${{ matrix.platform }})
    needs: checkout
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            python-version: "3.12"
          - os: ["codebuild-watchmaker-build-${{ github.run_id }}-${{ github.run_attempt }}", image:windows-3.0, image-size:medium]
            platform: windows
            python-version: "3.12"
    steps:
      - name: Retrieve source
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53
        with:
          name: source
          path: .

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install uv
        uses: astral-sh/setup-uv@5a7eac68fb9809dea845d802897dc5c723910fa3
        with:
          version: ${{ needs.checkout.outputs.uv-version }}
          activate-environment: "true"
          enable-cache: "false"

      - run: chmod +x ci/prep_docker.sh
        if: matrix.platform == 'linux'
      - run: ci/prep_docker.sh
        if: matrix.platform == 'linux'

      - run: ci/build.ps1
        if: matrix.platform == 'windows'
        shell: pwsh

      - name: Upload standalone binary
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4
        with:
          name: standalone-dists-${{ matrix.platform }}
          path: |
            .pyinstaller/dist/*/*
          if-no-files-found: error
          retention-days: 1

  test:
    needs:
      - build
      - checkout
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        python-version: ["3.8", "3.9", "3.10", "3.11", "3.12"]
        os: ["ubuntu-latest", "windows-2022"]
        include:
          - python-version: "3.7"
            os: "ubuntu-22.04"
    steps:
      - name: Retrieve source
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53
        with:
          name: source
          path: .

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install uv
        uses: astral-sh/setup-uv@5a7eac68fb9809dea845d802897dc5c723910fa3
        with:
          version: ${{ needs.checkout.outputs.uv-version }}
          activate-environment: "true"
          enable-cache: "true"
          prune-cache: false
          save-cache: ${{ github.ref == 'refs/heads/main' }}
          cache-dependency-glob: |
            requirements/*.txt
            pyproject.toml

      - run: uv pip install -r requirements/test.txt

      - name: Retrieve release distributions
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53
        with:
          name: dists
          path: dist/

      - name: Install package
        run: uv pip install ./dist/watchmaker-*.whl
        shell: bash

      - name: Run tests
        run: uv run pytest -vv tests

  lint:
    name: ${{ matrix.name }}
    needs:
      - build
      - checkout
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - python-version: "3.12"
            name: lint
    steps:
      - name: Retrieve source
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53
        with:
          name: source
          path: .

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install uv
        uses: astral-sh/setup-uv@5a7eac68fb9809dea845d802897dc5c723910fa3
        with:
          version: ${{ needs.checkout.outputs.uv-version }}
          activate-environment: "true"
          enable-cache: "true"
          prune-cache: false
          save-cache: ${{ github.ref == 'refs/heads/main' }}
          cache-dependency-glob: |
            requirements/*.txt
            pyproject.toml

      - run: uv pip install -r requirements/check.txt

      - name: Retrieve release distributions
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53
        with:
          name: dists
          path: dist/

      - name: Install package
        run: uv pip install ./dist/watchmaker-*.whl

      - run: uv run twine check dist/watchmaker-*.tar.gz
      - run: uv run ruff format --check .
      - run: uv run ruff check .

  docs:
    name: ${{ matrix.name }}
    needs:
      - build
      - checkout
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - python-version: "3.12"
            name: docs
    steps:
      - name: Retrieve source
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53
        with:
          name: source
          path: .

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install uv
        uses: astral-sh/setup-uv@5a7eac68fb9809dea845d802897dc5c723910fa3
        with:
          version: ${{ needs.checkout.outputs.uv-version }}
          activate-environment: "true"
          enable-cache: "true"
          prune-cache: false
          save-cache: ${{ github.ref == 'refs/heads/main' }}
          cache-dependency-glob: |
            requirements/*.txt
            pyproject.toml

      - run: uv pip install -r requirements/docs.txt

      - name: Retrieve release distributions
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53
        with:
          name: dists
          path: dist/

      - name: Install package
        run: uv pip install ./dist/watchmaker-*.whl

      - run: uv run sphinx-build -a -E -W --keep-going -b html docs dist/docs
      - run: uv run sphinx-build -b doctest docs dist/docs
      - run: uv run sphinx-build -b linkcheck docs dist/docs
