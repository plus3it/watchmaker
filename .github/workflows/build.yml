name: Build and test

on:
  # Run on demand
  workflow_dispatch:

  # Run pull requests against the default branch
  pull_request:
    branches: [main]

  # Run on push to default branch
  push:
    branches: [main]

concurrency:
  group: build-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  checkout:
    runs-on: ubuntu-latest
    outputs:
      release-condition: ${{ steps.release.outputs.condition }}
      release-version: ${{ steps.release.outputs.version }}
      pyapp-version: ${{ steps.tools.outputs.pyapp-version }}
      uv-version: ${{ steps.tools.outputs.uv-version }}
    steps:
      - name: Checkout code
        id: checkout
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3
        with:
          fetch-depth: 0
          fetch-tags: true
          submodules: recursive

      - name: Set version and check release condition
        id: release
        shell: bash
        run: |
          set -eu -o pipefail
          RELEASE=false
          PRIOR_VERSION=$(git describe --abbrev=0 --tags || true)
          RELEASE_VERSION=$(grep -E "current_version\s*=" .bumpversion.cfg | sed 's/^.*= //' )
          if [[ "$PRIOR_VERSION" = "$RELEASE_VERSION" ]]; then
            # If the current version matches the last tag, we are in a dev build.
            # Update the version in pyproject.toml to include a timestamp.
            ver=$(git show -s --format=%cd --date=format:'%Y%m%d%H%M%S')
            sed -i -E "s/^(version = \")([0-9]+\.[0-9]+\.[0-9]+)(\".*)?$/\1\2.dev$ver\3/" pyproject.toml
          else
            # If the current version does not match the last tag, we are in a release build.
            RELEASE=true
          fi
          VERSION="$(grep -E '^version\s*=' pyproject.toml | sed 's/^version = "\(.*\)"$/\1/')"
          echo "condition=${RELEASE}"
          echo "version=${VERSION}"
          echo "condition=${RELEASE}" >> "$GITHUB_OUTPUT"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Get tool versions
        id: tools
        run: |
          PYAPP_VERSION=$(sed -n 's/.*ofek\/pyapp@v//p' .github/workflows/dependabot_hack.yml)
          UV_VERSION=$(sed -n 's/^uv==//p' requirements/basics.txt)
          echo "pyapp-version=${PYAPP_VERSION}"
          echo "pyapp-version=${PYAPP_VERSION}" >> "$GITHUB_OUTPUT"
          echo "uv-version=${UV_VERSION}"
          echo "uv-version=${UV_VERSION}" >> "$GITHUB_OUTPUT"

      - name: Upload source
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4
        with:
          name: source
          path: ./**
          if-no-files-found: error
          include-hidden-files: true
          retention-days: 1

  build:
    name: ${{ matrix.name }}
    needs: checkout
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - python-version: "3.12"
            name: build
    steps:
      - name: Retrieve source
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53
        with:
          name: source
          path: .

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install uv
        uses: astral-sh/setup-uv@1e862dfacbd1d6d858c55d9b792c756523627244
        with:
          version: ${{ needs.checkout.outputs.uv-version }}
          activate-environment: "true"
          enable-cache: "false"

      - name: Build package
        run: uv build --verbose

      - name: Upload distributions
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4
        with:
          name: dists
          path: dist/
          if-no-files-found: error
          retention-days: 1

  standalone:
    name: standalone (${{ matrix.platform }})
    needs: checkout
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            python-version: "3.12"
          - os: ["codebuild-watchmaker-build-${{ github.run_id }}-${{ github.run_attempt }}", image:windows-3.0, image-size:medium]
            platform: windows
            python-version: "3.12"
    steps:
      - name: Retrieve source
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53
        with:
          name: source
          path: .

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install uv
        uses: astral-sh/setup-uv@1e862dfacbd1d6d858c55d9b792c756523627244
        with:
          version: ${{ needs.checkout.outputs.uv-version }}
          activate-environment: "true"
          enable-cache: "false"

      - run: chmod +x ci/prep_docker.sh
        if: matrix.platform == 'linux'
      - run: ci/prep_docker.sh
        if: matrix.platform == 'linux'

      - run: ci/build.ps1
        if: matrix.platform == 'windows'
        shell: pwsh

      - name: Upload standalone binary
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4
        with:
          name: standalone-dists-${{ matrix.platform }}
          path: |
            .pyinstaller/dist/*/*
          if-no-files-found: error
          retention-days: 1

  standalone-pyapp:
    name: standalone-pyapp (${{ matrix.platform }})
    needs:
      - build
      - checkout
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
          - os: ["codebuild-watchmaker-build-${{ github.run_id }}-${{ github.run_attempt }}", image:windows-3.0, image-size:medium]
            platform: windows
    steps:
      - name: Retrieve source
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53
        with:
          name: source
          path: .

      - name: Retrieve release distributions
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53
        with:
          name: dists
          path: dist/

      - name: Restore cargo cache
        id: cache-cargo
        uses: actions/cache/restore@0057852bfaa89a56745cba8c7296529d2fc39830
        with:
          path: |
            .pyapp/build/.cargo-cache
            .pyapp/build/target
          key: cargo-pyapp-${{ matrix.platform }}-${{ hashFiles('.github/workflows/dependabot_hack.yml') }}
          restore-keys: |
            cargo-pyapp-${{ matrix.platform }}-

      - name: Install uv
        uses: astral-sh/setup-uv@1e862dfacbd1d6d858c55d9b792c756523627244
        with:
          version: ${{ needs.checkout.outputs.uv-version }}
          enable-cache: true
          cache-local-path: .pyapp/build/.local-share/uv
          cache-dependency-glob: |
            requirements/build.txt
            pyproject.toml

      - name: Mark build script as executable (Linux)
        run: chmod +x ci/prep_docker_pyapp.sh
        if: matrix.platform == 'linux'
      - name: Build standalone binary with PyApp (Linux)
        run: ci/prep_docker_pyapp.sh
        if: matrix.platform == 'linux'

      - name: Build standalone binary with PyApp (Windows)
        if: matrix.platform == 'windows'
        run: ci/build_pyapp.ps1
        shell: pwsh

      - name: Exclude built pyapp binary from cache
        run: rm -rf .pyapp/build/target/release/build/pyapp-*
        shell: bash

      - name: Save cargo cache
        uses: actions/cache/save@0057852bfaa89a56745cba8c7296529d2fc39830
        if: always() && steps.cache-cargo.outputs.cache-hit != 'true'
        with:
          path: |
            .pyapp/build/.cargo-cache
            .pyapp/build/target
          key: ${{ steps.cache-cargo.outputs.cache-primary-key }}

      - name: Upload standalone binary
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4
        with:
          name: standalone-pyapp-dists-${{ matrix.platform }}
          path: |
            .pyapp/dist/*/*
          if-no-files-found: error
          retention-days: 1

  test:
    needs:
      - build
      - checkout
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        python-version: ["3.8", "3.9", "3.10", "3.11", "3.12"]
        os: ["ubuntu-latest", "windows-2022"]
    steps:
      - name: Retrieve source
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53
        with:
          name: source
          path: .

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install uv
        uses: astral-sh/setup-uv@1e862dfacbd1d6d858c55d9b792c756523627244
        with:
          version: ${{ needs.checkout.outputs.uv-version }}
          activate-environment: "true"
          enable-cache: "true"
          prune-cache: false
          save-cache: ${{ github.ref == 'refs/heads/main' }}
          cache-dependency-glob: |
            requirements/*.txt
            pyproject.toml

      - run: uv pip install -r requirements/test.txt

      - name: Retrieve release distributions
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53
        with:
          name: dists
          path: dist/

      - name: Install package
        run: uv pip install ./dist/watchmaker-*.whl
        shell: bash

      - name: Run tests
        run: uv run pytest -vv tests

  lint:
    name: ${{ matrix.name }}
    needs:
      - build
      - checkout
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - python-version: "3.12"
            name: lint
    steps:
      - name: Retrieve source
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53
        with:
          name: source
          path: .

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install uv
        uses: astral-sh/setup-uv@1e862dfacbd1d6d858c55d9b792c756523627244
        with:
          version: ${{ needs.checkout.outputs.uv-version }}
          activate-environment: "true"
          enable-cache: "true"
          prune-cache: false
          save-cache: ${{ github.ref == 'refs/heads/main' }}
          cache-dependency-glob: |
            requirements/*.txt
            pyproject.toml

      - run: uv pip install -r requirements/check.txt

      - name: Retrieve release distributions
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53
        with:
          name: dists
          path: dist/

      - name: Install package
        run: uv pip install ./dist/watchmaker-*.whl

      - run: uv run twine check dist/watchmaker-*.tar.gz
      - run: uv run ruff format --check .
      - run: uv run ruff check .

  docs:
    name: ${{ matrix.name }}
    needs:
      - build
      - checkout
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - python-version: "3.12"
            name: docs
    steps:
      - name: Retrieve source
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53
        with:
          name: source
          path: .

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install uv
        uses: astral-sh/setup-uv@1e862dfacbd1d6d858c55d9b792c756523627244
        with:
          version: ${{ needs.checkout.outputs.uv-version }}
          activate-environment: "true"
          enable-cache: "true"
          prune-cache: false
          save-cache: ${{ github.ref == 'refs/heads/main' }}
          cache-dependency-glob: |
            requirements/*.txt
            pyproject.toml

      - run: uv pip install -r requirements/docs.txt

      - name: Retrieve release distributions
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53
        with:
          name: dists
          path: dist/

      - name: Install package
        run: uv pip install ./dist/watchmaker-*.whl

      - run: uv run sphinx-build -a -E -W --keep-going -b html docs dist/docs
      - run: uv run sphinx-build -b doctest docs dist/docs
      - run: uv run sphinx-build -b linkcheck docs dist/docs
